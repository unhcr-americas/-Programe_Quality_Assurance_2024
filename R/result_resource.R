# WARNING - Generated by {fusen} from dev/function_documentation.Rmd: do not edit by hand

#' result_resource
#' 
#' This display a charts to review jointly indicators and resource allocation
#' 
#' @param data table resulting from  prepare_qa_data()
#' @param thisind which indicator to chart
#' @param budget table  from results.unhcr.org 4.6.1_Budget_Download.xlsx 
#' @param thisoutcome which outcome to chart
#' @param poptype poptype filter - default is null 
#'
#' @importFrom unhcrthemes theme_unhcr
#'
#' @return ggplot2 
#' 
#' @return
#' 
#' @export
#' @examples
#'
#' data <- prepare_qa_data(activityInfoTable= "cdn6y40lm87wi522")
#' knitr::kable(data |>  
#'                dplyr::filter(means_verification_results_level == "Outcome" ) |>
#'                dplyr::arrange( means_verification_indicator_code) |>
#'                dplyr::select(  means_verification_outcome_area, 
#'                                means_verification_indicator) |>
#'                dplyr::distinct())
#' ## budget data to be downloaded and save locally
#'
#' budget <- readxl::read_excel( system.file("4.6.1_Budget_Download.xlsx", package = "ProgQA"),  skip = 1)|>  
#' #budget <- readxl::read_excel( here::here("data-raw", "4.6.1_Budget_Download.xlsx"),  skip = 1)|>
#'   janitor::clean_names() 
#'
#' result_resource(data,
#'                 budget, 
#'                 thisind = "1.1 Proportion of refugees and asylum seekers registered on an individual basis.",
#'                 thisoutcome = "OA1: Access/Doc")
#'
#' result_resource(data, budget,
#'                         poptype = "Refugees and Asylum-seekers",
#' thisind = "13.3 Proportion of PoC (working age) who are unemployed.",  thisoutcome = "OA13: Livelihood")
result_resource <- function(data, 
                            thisind,
                            budget,
                            thisoutcome,
                            poptype = NULL){
data.outcome <- data |>
  dplyr::filter(means_verification_results_level == "Outcome" )  |>
  dplyr::filter(means_verification_indicator == thisind )


## merge data on indicators and the one on budget
budget_outcome <- budget |>
  dplyr::filter(scenario == "Detailed WOL") |>
  dplyr::group_by(operation_code, operation,  outcome_area) |>
  dplyr::summarise(cost_usd = sum(cost_usd, na.am = TRUE)) |>
  dplyr::group_by(operation_code, operation) |>
  dplyr::mutate( sector_pct = round( cost_usd / sum(cost_usd, na.am = TRUE) * 100, 2) )|>
  dplyr::filter(outcome_area == thisoutcome )

dfall <- data.outcome |>
  dplyr::left_join(budget_outcome , by= c("means_verification_outcome_area" = "outcome_area" , "operation_mco" = "operation"
  ) )  |>
  dplyr::mutate(  actual = as.numeric(actual_2023),
                  baseline = as.numeric(baseline_2023),
                  target = as.numeric(target_2023)  )   |>
## Treat case when no corresponding resource allocation
  dplyr::filter (! (is.na(sector_pct)))

if(!(is.null(poptype))) {
  dfall <- dfall  |>
  ## Treat case when no corresponding resource allocation
    dplyr::filter (poptype %in% c(poptype))
  }

## case there's no data at all
if( nrow(dfall) == 0) {
  info <-  paste0("No  \n comparative analysis \n  could be produced for \n",
                  thisoutcome, "\n  & indicator \n in ",
                  thisind , "   " )
  p <- ggplot2::ggplot() +
    ggplot2::annotate("text",  x = 1, y = 1, size = 4,
                      label = info ) +
    ggplot2::theme_void()

} else if(nrow(dfall)> 0) {

  ## Background with color band for beter interpreation in line with standards!
  maxgreen <- max(dfall$threshold_green)
  maxorange <- max(dfall$threshold_orange)
  maxred <- max(dfall$threshold_red)
  palette_level <- c( "critical"= "#D3212C",
                      "notcool"="#FF980E",
                      "Acceptable"= "#069C56")
  if( unique(dfall$Reverse) == TRUE ) {
    threshold = data.frame(
      indlevel = c("critical","notcool", "Acceptable"),
      xmin = c(0, 0, 0 ),
      # xmax = c(100, 100, 100 ),
      # xmin = c(min(dfall$sector_pct), min(dfall$sector_pct), min(dfall$sector_pct) ),
      xmax = c(max(dfall$sector_pct)+5, max(dfall$sector_pct)+5, max(dfall$sector_pct)+5 ),
      ymin = c( 0,  maxgreen , maxorange ), #
      ymax = c( maxgreen ,  maxorange, maxred )  #
    )

  }  else if (  unique(dfall$Reverse) == FALSE) {
    threshold = data.frame(
      indlevel = c("critical","notcool", "Acceptable"),
      xmin = c(0, 0, 0 ),
      # xmin = c(min(dfall$sector_pct), min(dfall$sector_pct), min(dfall$sector_pct) ),
      xmax = c(max(dfall$sector_pct)+5, max(dfall$sector_pct)+5, max(dfall$sector_pct)+5 ),
      ymin = c( 0,  maxred, maxorange ),
      ymax = c( maxred,  maxorange, maxgreen )
    )
  }


  interpretation <- "Indicator Value Interpretation: circle=Actual Reported Value, square=baseline, triangle=Target, color=Standard Acceptability Threshold"

    ## and now the plot without country focus
    p  <-  ggplot2::ggplot( dfall, ggplot2::aes( x = sector_pct))  +
      ggplot2::geom_rect( data=  threshold,
                          ggplot2::aes(xmin = xmin, xmax = xmax,
                                       ymin = ymin, ymax = ymax,
                                       fill = indlevel),
                          inherit.aes = FALSE,
                          alpha = 0.4)  +
      ggplot2::guides(fill = "none") +
      ggplot2::scale_fill_manual(values = palette_level,
                                 drop = TRUE,
                                 limits = force,
                                 na.value = "grey50") +
      ggplot2::facet_wrap( ggplot2::vars(means_verification_population_type),
                           labeller = ggplot2::labeller(means_verification_population_type = ggplot2::label_wrap_gen(20)))  +
      ggplot2::geom_segment(ggplot2::aes(x = sector_pct,
                                           y = baseline,
                                           xend = sector_pct,
                                           yend = target),
                              color = "black")  +
      ggplot2::geom_point( ggplot2::aes(y = baseline), size = 1.5, shape = 22, fill = "black") +
      ggplot2::geom_point( ggplot2::aes(y = target), size = 1.5 , shape = 24, fill = "black")  +
      ggplot2::geom_point( ggplot2::aes(y = actual ),
                           size = 3.5, shape =  21, fill = "blue", alpha =0.7) +
      ggrepel::geom_label_repel(ggplot2::aes(y = actual,
                                             label = operation_mco ),
                                size = 3  ) +
      ggplot2::guides(color = "none", fill = "none")  +
      ggplot2::scale_x_continuous( label =  scales::label_number(accuracy = 1,
                                                                 scale_cut = scales::cut_short_scale()) ) +
      ggplot2::scale_y_continuous( label =  scales::label_number(accuracy = 1,
                                                                 scale_cut = scales::cut_short_scale())) +
      unhcrthemes::theme_unhcr(font_size = 14,
                               axis_text_size = 9,
                               grid = "XY",
                               axis = "y", legend = TRUE) +
      ggplot2::theme( legend.direction = "horizontal",
                      legend.box = "horizontal",
                      legend.position = "bottom") +
      ## Add  correlation
      # ggplot2::annotate("text",
      #                   x = max(dfall$sector_pct),
      #                   y = max(dfall$actual),
      #                   label = paste("Correlation [-1, 1] = ",
      #                                 round(cor(dfall$sector_pct, dfall$actual, method = "pearson"),2)),
      #                   color = "gray95",
      #                   hjust = 0,
      #                   vjust = 1) +
      ggplot2::labs( y = "Indicator Value ",
                     x = "% of resource allocation (expenditure) spent on this outcome" ,
                     title = paste0("Results for Indicator: ",  thisind, " | 2023" ) ,
                     subtitle = stringr::str_wrap(
                       paste0(  "Correlation: ",
                                round(cor(dfall$sector_pct, dfall$actual, method = "pearson"),2),
                                " to Resources for Outcome: ", thisoutcome ) ,
                       100) ,
                     caption = stringr::str_wrap( paste0(
                      "Source: UNHCR RBM / Compass (provisional)" ,
                       ". ---> ",
                       interpretation),
                       110) )
}
return(p)
}
